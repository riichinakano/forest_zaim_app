# 林業財務分析アプリ (forest_zaim_app)

月次損益計算書（PL）・貸借対照表（BS）データを可視化・分析し、AIによる自然言語での財務分析が可能なStreamlitアプリケーション

## 機能概要

### Phase 1（実装済み - 2025-12-08）
- 月次損益計算書（PL）の推移分析
- 複数年度の比較グラフ表示（最大5年度）
- 科目別の月次推移可視化
- **3階層集計機能**:
  - 個別科目表示
  - 中分類合算（製造原価、販管費、営業外収益等）
  - 大分類合算（収益・費用）
- データテーブル表示（前年比・**月度平均**自動計算）
- CSV/Excel出力（書式設定付き）
- 重要科目対応（支払利息、年賦利息、長期前払費用償却、固定資産除却損、山林圧縮損、法人税等）

### Phase 1.5（実装済み - 2025-12-09）
- **貸借対照表（BS）分析機能**
- BS月次残高推移グラフ（ストックデータ可視化）
- BS 3階層集計（流動資産、固定資産、流動負債、固定負債、純資産）
- BS中分類合算（現金及び預金、有形固定資産、長期借入金等）
- BS年度比較テーブル（月度平均行含む）
- BSデータCSV/Excelエクスポート

### Phase 2（実装済み - 2025-12-11）
- **AIチャット機能（Gemini API連携）**
- 自然言語での財務データ分析
- Gemini 2.5 Flashモデルによるコード生成
- 動的データ参照（PL/BS 10年分）
- 参考資料アップロード（CSV/Excel対応）
- コード安全性チェック・承認フロー
- エラー自動修正（最大3回再試行）
- グラフ・データ自動生成（Plotly）
- 会話ログ保存（Markdown形式、Obsidian互換）

## システム要件

- Python 3.9以上
- 推奨OS: Windows 10/11, macOS 12以上, Ubuntu 20.04以上
- メモリ: 4GB以上推奨
- Gemini API キー（AIチャット機能を使用する場合）

## インストール手順

### 1. リポジトリのクローン/ダウンロード

```bash
git clone https://github.com/riichinakano/forest_zaim_app.git
cd forest_zaim_app
```

### 2. 仮想環境の作成（推奨）

```bash
# Windowsの場合
python -m venv venv
venv\Scripts\activate

# macOS/Linuxの場合
python3 -m venv venv
source venv/bin/activate
```

### 3. 依存ライブラリのインストール

```bash
pip install -r requirements.txt
```

### 4. APIキーの設定（AIチャット機能を使用する場合）

プロジェクトルートに `.env` ファイルを作成し、Gemini APIキーを設定：

```
GEMINI_API_KEY=your_api_key_here
```

**APIキーの取得方法**:
1. [Google AI Studio](https://aistudio.google.com/) にアクセス
2. 「Get API key」をクリック
3. APIキーをコピーして `.env` ファイルに貼り付け

## データ準備

### ディレクトリ構成

```
forest_zaim_app/
├── app.py                       # トップページ
├── requirements.txt
├── README.md
├── .env                         # APIキー（Git管理外）
├── pages/                       # Streamlit Pages（Phase 2で追加）
│   ├── 1_📊_PL分析.py
│   ├── 2_💰_BS分析.py
│   └── 3_💬_AIチャット.py
├── modules/
│   ├── __init__.py
│   ├── data_loader.py
│   ├── visualizer.py
│   ├── exporter.py
│   ├── gemini_chat.py           # Gemini API連携（Phase 2で追加）
│   └── financial_analyzer.py    # データローダー・ログ管理（Phase 2で追加）
├── config/
│   ├── account_master.csv       # PL科目マスタ
│   └── bs_account_master.csv    # BS科目マスタ
├── data/
│   ├── monthly_pl/              # PL月次データ
│   │   ├── H27_monthly.csv
│   │   └── ...
│   ├── monthly_bs/              # BS月次データ
│   │   ├── H27_monthly_bs.csv
│   │   └── ...
│   └── uploaded/                # アップロードファイル（Phase 2で追加）
├── notebooks/
│   └── chat_logs/               # 会話ログ（Phase 2で追加）
└── docs/
    ├── requirements_definition.md  # 要件定義書（Phase 2で追加）
    └── gemini_models.md            # Geminiモデル仕様（Phase 2で追加）
```

### CSVファイル形式

#### PL（損益計算書）データ

各年度のCSVファイルは以下の形式で準備してください：

```csv
タイトル,科目コード,科目名称,当月迄累計金額,当月迄累計構成比,4月,5月,6月,7月,8月,9月,10月,11月,12月,1月,2月,3月
損益計算書,410,売上高,33067288,100.0,1100602,1082144,204391,404442,487604,973434,347514,12959513,14689169,0,0,818475
損益計算書,620,役員報酬,7400000,22.4,200000,600000,600000,600000,600000,600000,600000,600000,600000,600000,600000,1200000
```

**必須項目：**
- 科目コード（数値）
- 科目名称（文字列）
- 4月〜3月の月次金額（数値）

**注意事項：**
- エンコーディング: Shift-JIS
- ファイル名: `{年度}_monthly.csv` 形式
- 年度表記: H27, H28, ..., R1, R2, R3, ..., R6

#### BS（貸借対照表）データ

各年度のCSVファイルは以下の形式で準備してください：

```csv
コード,科目名称,4月（当月残高）,5月（当月残高）,6月（当月残高）,...,3月（当月残高）
111,現金,177658,187041,181232,...,195061
130,南都普通,11508289,11863363,14659736,...,15759976
```

**必須項目：**
- コード（数値、**「科目コード」ではなく「コード」列を使用**）
- 科目名称（文字列）
- 4月（当月残高）〜3月（当月残高）の月次残高（数値）

**注意事項：**
- エンコーディング: Shift-JIS
- ファイル名: `{年度}_monthly_bs.csv` 形式
- 年度表記: H27, H28, ..., R1, R2, R3, ..., R6
- **列名が「コード」であることに注意**（PLの「科目コード」とは異なる）
- データはストック（残高）であり、PLの累計金額とは性質が異なる

## 起動方法

```bash
streamlit run app.py
```

ブラウザが自動的に開き、以下のURLでアクセスできます：
```
http://localhost:8501
```

## 使い方

### トップページ

アプリケーション起動後、以下の3つのページが選択できます：

1. **📊 PL分析** - 損益計算書の可視化・分析
2. **💰 BS分析** - 貸借対照表の可視化・分析
3. **💬 AIチャット** - 自然言語での財務データ分析

### PL（損益計算書）分析

1. **科目選択**
   - サイドバーから分析したい科目を選択
   - **📊 大分類：収益（合算）** - 全収益科目の合計を表示
   - **📊 大分類：費用（合算）** - 全費用科目の合計を表示
   - **📈 中分類：製造原価（合算）** - 製造原価科目の合計を表示
   - **📈 中分類：販管費（合算）** - 販管費科目の合計を表示
   - 個別科目選択 - 売上高、役員報酬、給料手当、支払利息など60科目以上

2. **年度選択**
   - 比較したい年度を複数選択可能（最大5年度）
   - マルチセレクトで選択

3. **グラフ表示**
   - Plotly折れ線グラフで月次推移を表示
   - ホバーで詳細データ確認
   - ズーム・パン機能あり
   - 年度ごとに色分け表示

4. **データテーブル**
   - グラフ下部に数値テーブル表示
   - 年間合計・前年比・**月度平均**を自動計算
   - 3桁カンマ区切り表示

5. **エクスポート**
   - CSV出力：UTF-8 BOM付きで出力（Excel対応）
   - Excel出力：書式設定付き（罫線、カンマ区切り、前年比の色分け）

### BS（貸借対照表）分析

1. **BS科目選択**
   - サイドバーから分析したいBS科目を選択
   - **📊 大分類：流動資産（合算）** - 流動資産科目の合計を表示
   - **📊 大分類：固定資産（合算）** - 固定資産科目の合計を表示
   - **📊 大分類：流動負債（合算）** - 流動負債科目の合計を表示
   - **📊 大分類：固定負債（合算）** - 固定負債科目の合計を表示
   - **📊 大分類：純資産（合算）** - 純資産科目の合計を表示
   - **📈 中分類：現金及び預金（合算）** - 現金及び預金科目の合計を表示
   - **📈 中分類：有形固定資産（合算）** - 有形固定資産科目の合計を表示
   - **📈 中分類：長期借入金（合算）** - 長期借入金科目の合計を表示
   - 個別科目選択 - 現金、南都普通、立木、長期借入金など29科目

2. **グラフ表示**
   - Plotly折れ線グラフで月次残高推移を表示
   - Y軸: 残高（円）
   - ストックデータのため、各月の時点残高を表示

3. **データテーブル**
   - 年間合計（12ヶ月の残高合計）・前年比・**月度平均**を自動計算
   - 月度平均：選択された全年度の各月の平均値

4. **エクスポート**
   - CSV/Excel出力可能（PLと同様の機能）

### AIチャット機能

**新機能（Phase 2）**: 自然言語で財務データを分析できます。

#### 使い方

1. **セッション開始**
   - サイドバーから「🆕 新規セッション開始」をクリック
   - セッションのテーマ（任意）を入力

2. **質問入力**
   - チャット入力欄に自然言語で質問を入力
   - 例: 「R6の売上高を教えて」
   - 例: 「R6とR5の借入返済額を比較して」
   - 例: 「過去5年間の役員報酬推移をグラフ化して」
   - 例: 「令和6年度の費用内訳を円グラフで表示して」

3. **コード確認・承認**
   - Gemini APIが生成したPythonコードが表示される
   - 「▶️ 実行」ボタンをクリックしてコードを実行
   - 「❌ キャンセル」ボタンで実行をキャンセル

4. **結果確認**
   - テキスト回答、グラフ、データテーブルが表示される
   - グラフはインタラクティブに操作可能

5. **会話保存**
   - サイドバーの「💾 会話を保存」ボタンでMarkdown形式で保存
   - `notebooks/chat_logs/{セッションID}/conversation.md` に保存

#### 参考資料アップロード

- サイドバーから追加のCSV/Excelファイルをアップロード可能
- アップロードしたファイルはAIが自動で認識して分析に使用

#### グラフ保存形式

- HTML形式（インタラクティブ）
- PNG形式（静的画像）
- サイドバーから保存形式を選択可能

#### 利用可能なモデル

- **Gemini 2.5 Flash（推奨）★**: バランスの取れた性能（無料枠で利用可能）

#### データ参照範囲

- PL（損益計算書）: H27～R6（10年分）
- BS（貸借対照表）: H27～R6（10年分）
- 科目マスタ: PL科目、BS科目

#### 安全性機能

- コード実行前の安全性チェック
- 禁止操作の検出（ファイル削除、外部プロセス起動等）
- エラー時の自動修正（最大3回再試行）

## トラブルシューティング

### データが表示されない

**原因1: CSVファイルが見つからない**
```
解決策: data/monthly_pl/ または data/monthly_bs/ ディレクトリにCSVファイルが配置されているか確認
```

**原因2: CSVファイルの形式が正しくない**
```
解決策: エンコーディング（Shift-JIS）と列構成を確認
```

**原因3: 科目コードが見つからない**
```
解決策: config/account_master.csv または config/bs_account_master.csv に該当科目が登録されているか確認
```

### AIチャットが動作しない

**原因1: APIキーが設定されていない**
```
解決策: .env ファイルに GEMINI_API_KEY を設定
```

**原因2: APIキーが無効**
```
解決策: Google AI Studio で APIキーを再確認
```

**原因3: API利用制限（Rate Limit）**
```
解決策: しばらく待ってから再試行（無料枠の制限に注意）
```

### グラフが表示されない

```bash
# Plotlyのキャッシュをクリア
streamlit cache clear
```

### メモリ不足エラー

```
解決策: 選択年度数を減らす（最大5年度まで）
```

## よくある質問（FAQ）

**Q1: 新しい年度のデータを追加するには？**

A: `data/monthly_pl/` または `data/monthly_bs/` に新年度のCSVファイルを配置し、アプリを再起動してください。

**Q2: 科目を追加・削除するには？**

A: `config/account_master.csv` または `config/bs_account_master.csv` を編集してください。アプリは自動的に反映します。

**Q3: エクスポートしたファイルはどこに保存される？**

A: ブラウザのダウンロードフォルダに保存されます。

**Q4: 複数の科目を同時に表示できますか？**

A: 「📊 大分類：収益（合算）」「📊 大分類：費用（合算）」を選択すると、該当する全科目の合計を表示できます。

**Q5: AIチャットで複雑な分析はできますか？**

A: はい。以下のような分析が可能です：
- 複数年度の利益指標の推移分析
- 費用構成比の可視化（円グラフ）
- 借入返済額の比較分析
- 収益性の向上に関する意見

**Q6: 会話ログはどこに保存されますか？**

A: `notebooks/chat_logs/{セッションID}/conversation.md` にMarkdown形式で保存されます。Obsidianなどのマークダウンエディタで閲覧可能です。

## ライセンス

本アプリケーションは社内利用を目的としています。

## サポート

問題が発生した場合は、GitHubのIssuesページで報告してください：
https://github.com/riichinakano/forest_zaim_app/issues

以下の情報を添えてください：
1. エラーメッセージ
2. 使用しているPythonバージョン (`python --version`)
3. 操作手順
4. スクリーンショット（可能な場合）

## 更新履歴

### Version 1.2.0 (2025-12-11)
- **Phase 2実装完了: AIチャット機能追加**
- Gemini API連携（Gemini 2.5 Flash）
- 自然言語での財務データ分析
- コード生成・承認・実行フロー
- 参考資料アップロード機能（CSV/Excel）
- セッション管理・会話ログ保存（Markdown形式）
- グラフ・データ自動生成（Plotly）
- エラー自動修正機能（最大3回再試行）
- Streamlit Pages化（PL分析、BS分析、AIチャット）
- トップページ追加（ナビゲーション機能）
- システムプロンプト強化（データ構造、利益計算方法の詳細説明）

### Version 1.1.0 (2025-12-09)
- **Phase 1.5実装完了: BS（貸借対照表）機能追加**
- タブUI導入（PL/BS切り替え）
- BS月次残高推移グラフ
- BS 3階層集計（個別科目、中分類、大分類）
- BS科目マスタ（29科目）
- BS年度比較テーブル（月度平均行含む）
- BSデータCSV/Excelエクスポート
- PL/BS両方で月度平均行を表示

### Version 1.0.0 (2025-12-08)
- Phase 1実装完了
- 月次推移分析機能
- 複数年度比較機能（最大5年度）
- 大分類合算表示機能（収益・費用）
- 中分類合算表示機能（製造原価、販管費等）
- CSV/Excel出力機能
- 重要科目追加（支払利息、年賦利息、長期前払費用償却、固定資産除却損、山林圧縮損、法人税等）
- 60科目以上の科目マスタ整備
- 前年比自動計算機能
- エラーハンドリング改善

---

**開発者:** Claude Code & User
**最終更新:** 2025-12-11
**バージョン:** 1.2.0
