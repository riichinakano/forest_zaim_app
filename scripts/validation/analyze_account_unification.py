import pandas as pd
import os
import sys

# UTF-8出力設定
sys.stdout.reconfigure(encoding='utf-8')

# 実データから全科目を集計
data_dir = "data/monthly_pl"
years = ['H27', 'H28', 'H29', 'H30', 'H31', 'R2', 'R3', 'R4', 'R5', 'R6']

print("=" * 80)
print("科目コード統一可能性の詳細分析")
print("=" * 80)

# 各年度のデータで、同一年度内に同じ科目名が複数コードで存在するかチェック
for year in years:
    filepath = os.path.join(data_dir, f"{year}_monthly.csv")
    if os.path.exists(filepath):
        df = pd.read_csv(filepath, encoding='shift-jis')

        # 科目名称でグループ化して、複数コードがあるものを抽出
        name_groups = df.groupby('科目名称')['科目コード'].apply(list).to_dict()
        duplicates = {name: codes for name, codes in name_groups.items() if len(set(codes)) > 1}

        if duplicates:
            print(f"\n【{year}年度】同一年度内で複数コードの科目:")
            for name in sorted(duplicates.keys()):
                codes = sorted(set(duplicates[name]))
                codes_str = ', '.join([str(c) for c in codes])
                print(f"  {name:15s} | コード: {codes_str}")

                # この科目名が含まれる全行を表示（金額の有無確認）
                subset = df[df['科目名称'] == name][['科目コード', '科目名称', '当月迄累計金額']]
                for _, row in subset.iterrows():
                    amount = row['当月迄累計金額']
                    print(f"    - コード{row['科目コード']:4d}: 累計金額 {amount:,}円")

print("\n" + "=" * 80)
print("統一の推奨案")
print("=" * 80)

print("""
【基本方針】
同一科目名で複数コードが存在する場合、以下の2パターンがあります：

1. 製造原価 vs 販管費の分類違い
   → 統一すべきではない（会計上の分類が異なるため）
   例: 修繕費（546=製造原価、632=販管費）

2. 実質的に同じ科目だが、コードが異なる
   → 統一可能（データの一貫性向上のため）
   例: 退職金（623 vs 863）

【分析結果】

■ 統一すべきでない科目（製造原価 vs 販管費）
  - リース料 (553=製造原価, 631=販管費)
  - 修繕費 (546=製造原価, 632=販管費)
  - 旅費交通費 (542/543=製造原価, 634=販管費) ※542と543は製造原価内で重複
  - 消耗品費 (515/543=製造原価, 634/636=販管費)
  - 減価償却費 (516/545=製造原価, 630/648=販管費)
  - 租税公課 (547/548=製造原価, 638/639=販管費)
  - 福利厚生費 (544=製造原価, 628/630=販管費)
  - 通信費 (545=製造原価, 635/641=販管費)
  - 地代家賃 (552=製造原価, 642/647=販管費)
  - 雑費 (559=製造原価, 646/655=販管費)

■ 統一可能な科目（年度が重複していない）
  1. 退職金: 863 (H27,H28) → 623 に統一
     理由: 年度が重複せず、H29以降は623を使用

  2. 委託費: 611 (R2) → 540 に統一
     理由: 年度が重複せず、R5以降は540を使用

■ 要調査科目（同一年度・同一分類内で重複）
  1. 仕入高: 431 vs 517
     → どちらも同一年度に出現。実データで用途が異なる可能性
     → 431は「受託収入」の可能性（科目マスタ参照）

  2. 役員報酬: 610 vs 611 vs 620 (すべて販管費)
     → 複数の役員がいる可能性（代表、専務など）
     → 統一せず、別々に管理すべき

  3. 保険料: 548/638/640 (製造原価と販管費)
     → 638と640は両方販管費で重複
     → データで用途確認が必要

  4. 同一分類内の重複（製造原価のみ、または販管費のみで複数コード）
     - 旅費交通費: 542 vs 543 (両方とも製造原価)
     - 修繕費: 632 vs 637 (両方とも販管費)
     - 地代家賃: 642 vs 647 (両方とも販管費)
     - 通信費: 635 vs 641 (両方とも販管費)
     - 福利厚生費: 628 vs 630 (両方とも販管費)
     - 雑費: 646 vs 655 (両方とも販管費)
     - 雑損失: 850 vs 911 (両方とも営業外費用)

【推奨アクション】
1. すぐに統一可能: 退職金(863→623), 委託費(611→540)
2. 用途確認後に判断: 同一分類内の重複科目
3. 統一しない: 製造原価 vs 販管費で分類が異なる科目
""")
