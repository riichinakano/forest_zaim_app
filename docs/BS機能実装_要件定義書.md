# BS（貸借対照表）機能実装 要件定義書

**バージョン:** 1.0.0  
**作成日:** 2025-12-09  
**対象アプリ:** forest_zaim_app  
**実装フェーズ:** Phase 1.5（BS追加）

---

## 1. 概要

### 1.1 目的
既存のPL（損益計算書）分析機能に加え、BS（貸借対照表）の月次推移分析機能を追加する。

### 1.2 実装範囲
- PL/BS切り替えUI（タブ形式）
- BS科目マスタの作成
- BS月次データの読み込み・可視化
- 複数年度比較（最大5年度）
- データテーブル表示（月次平均値を含む）
- CSV/Excelエクスポート

### 1.3 対象外
- キャッシュフロー分析（Phase 2で実装）
- 財務指標計算（流動比率、自己資本比率など）
- BS/PLの連動分析

---

## 2. データ仕様

### 2.1 データソース

#### 2.1.1 月次BSデータ
**ファイル名:** `{年度}_monthly_bs.csv`  
**配置先:** `data/monthly_bs/`  
**エンコーディング:** Shift-JIS  
**使用列:** 「当月残高」列（12ヶ月分）

**列構成:**
```csv
コード,科目名称,4月（前月残高）,...,3月（前月残高）,4月（当月借方）,...,3月（当月借方）,4月（当月貸方）,...,3月（当月貸方）,4月（当月残高）,5月（当月残高）,...,3月（当月残高）
111,現金,...,150238,61568,123957,...,81232
```

**採用するデータ:** 「4月（当月残高）」〜「3月（当月残高）」の12列

#### 2.1.2 決算書データ（補助）
**ファイル名:** `{年度}_fs.csv`  
**配置先:** `data/fs/`  
**用途:** 期末確定値・構成比の参照用（Phase 2で活用）

### 2.2 科目コード体系

| コード範囲 | 大分類 | 中分類 | 具体例 |
|-----------|--------|--------|--------|
| **111-199** | **流動資産** | 現金及び預金 | 現金(111), 南都普通(130), ＪＡ普通(131) |
| | | 流動資産その他 | 前払費用(171), 仮払金(174), 未収入金(176) |
| **210-299** | **固定資産** | 有形固定資産 | 建物(210), 車輌運搬具(214), 山林(216), 土地(217) |
| | | 投資その他資産 | 出資金(240), 長期預け金(241), 長期前払費用(242) |
| **310-329** | **流動負債** | - | 買掛金(312), 短期借入金(314), 未払金(317), 未払費用(318) |
| **340-399** | **固定負債** | - | 長期借入金(340), 長期未払金(341) |
| **370-399** | **純資産** | 資本 | 資本金(370), 資本準備金(380), 利益準備金(381), 別途積立金(390) |

**注意:**
- コード400-899は損益科目（PLと共通）のため、BS科目マスタには含めない
- コード900番台（期首繰越利益剰余金920など）は純資産として扱う
- コード9500番台以降は合計行（【流動資産】など）

### 2.3 大分類定義

以下の6大分類を採用：

1. **流動資産** (111-199)
2. **固定資産** (210-299)
3. **流動負債** (310-329)
4. **固定負債** (340-369)
5. **純資産** (370-999)
6. **資産合計** (111-299の合算)
7. **負債合計** (310-399の合算)
8. **負債及び純資産合計** (310-999の合算)

### 2.4 中分類定義（参考）

| 大分類 | 中分類 | 科目コード範囲 |
|--------|--------|----------------|
| 流動資産 | 現金及び預金 | 111-149 |
| 流動資産 | その他流動資産 | 150-199 |
| 固定資産 | 有形固定資産 | 210-239 |
| 固定資産 | 投資その他資産 | 240-299 |
| 流動負債 | - | 310-329 |
| 固定負債 | - | 340-369 |
| 純資産 | 資本 | 370-399 |
| 純資産 | 利益剰余金 | 900-999 |

---

## 3. 機能要件

### 3.1 PL/BS切り替えUI

#### 3.1.1 実装方法
**採用手法:** Streamlit `st.tabs()` による横タブ形式

```python
tab_pl, tab_bs = st.tabs(["📊 損益計算書 (PL)", "💼 貸借対照表 (BS)"])

with tab_pl:
    # 既存のPL分析機能

with tab_bs:
    # 新規BS分析機能
```

#### 3.1.2 タブ表示順序
1. 📊 損益計算書 (PL) - デフォルトで開く
2. 💼 貸借対照表 (BS)

#### 3.1.3 各タブの独立性
- 科目選択、年度選択、グラフ表示、エクスポートはタブごとに独立
- PL/BS間でデータ連携は行わない（Phase 2で実装）

### 3.2 科目マスタ

#### 3.2.1 ファイル構成
**BS専用マスタ:** `config/bs_account_master.csv`

**列構成:**
```csv
科目コード,科目名,大分類,中分類,表示順
111,現金,流動資産,現金及び預金,1
130,南都普通,流動資産,現金及び預金,2
131,ＪＡ普通,流動資産,現金及び預金,3
171,前払費用,流動資産,その他流動資産,4
174,仮払金,流動資産,その他流動資産,5
176,未収入金,流動資産,その他流動資産,6
210,建物,固定資産,有形固定資産,7
214,車輌運搬具,固定資産,有形固定資産,8
215,工具器具備品,固定資産,有形固定資産,9
216,山林,固定資産,有形固定資産,10
217,土地,固定資産,有形固定資産,11
240,出資金,固定資産,投資その他資産,12
241,長期預け金,固定資産,投資その他資産,13
242,長期前払費用,固定資産,投資その他資産,14
312,買掛金,流動負債,流動負債,15
314,短期借入金,流動負債,流動負債,16
317,未払金,流動負債,流動負債,17
318,未払費用,流動負債,流動負債,18
321,住民税預り金,流動負債,流動負債,19
323,預り金,流動負債,流動負債,20
327,未払法人税,流動負債,流動負債,21
329,未払消費税,流動負債,流動負債,22
340,長期借入金,固定負債,固定負債,23
341,長期未払金,固定負債,固定負債,24
370,資本金,純資産,資本,25
380,資本準備金,純資産,資本,26
381,利益準備金,純資産,資本,27
390,別途積立金,純資産,資本,28
920,期首繰越利益剰余金,純資産,利益剰余金,29
```

**エンコーディング:** UTF-8（BOM付き推奨）

#### 3.2.2 科目マスタの範囲
- **採用:** コード111-399, 920（BS専用科目のみ）
- **除外:** コード400-899（損益科目）
- **除外:** コード9500番台以降（合計行）

#### 3.2.3 PLマスタとの関係
- **完全に独立したファイル** として管理
- `config/account_master.csv`（PL用）と`config/bs_account_master.csv`（BS用）を分離
- データローダーで自動判別して読み込み

### 3.3 データ読み込み

#### 3.3.1 モジュール拡張
**対象ファイル:** `modules/data_loader.py`

**追加関数:**
```python
def load_bs_monthly_data(data_dir: str) -> pd.DataFrame:
    """
    BS月次データを読み込み統合
    
    Args:
        data_dir: データディレクトリ（data/monthly_bs）
    
    Returns:
        統合されたBS月次データ
    """

def load_bs_account_master(config_dir: str) -> pd.DataFrame:
    """
    BS科目マスタを読み込み
    
    Args:
        config_dir: 設定ディレクトリ（config）
    
    Returns:
        BS科目マスタデータ
    """
```

#### 3.3.2 データ変換処理
1. **列名統一:** 「4月（当月残高）」→「4月」に変換
2. **年度列追加:** ファイル名から年度を抽出（例: R6_monthly_bs.csv → R6）
3. **年間合計列追加:** 4月〜3月の合計値を計算（流動性指標用）

**注意:** BSの「年間合計」は参考値（期末残高を12倍ではない）

### 3.4 グラフ表示

#### 3.4.1 月次推移グラフ
**既存機能を流用:** `modules/visualizer.py`の`create_monthly_trend_chart()`

**BS固有の調整:**
- Y軸ラベル: 「金額（円）」→「残高（円）」
- グラフタイトル: 「月次推移」→「月次残高推移」
- ホバー表示: 「金額」→「残高」

#### 3.4.2 複数年度比較
- PLと同様、最大5年度まで選択可能
- 年度ごとに異なる色で表示
- 凡例表示

#### 3.4.3 集計機能
PLと同様の3階層集計をサポート:

1. **個別科目:** 現金(111)、南都普通(130)など
2. **中分類合算:** 「現金及び預金」「有形固定資産」など
3. **大分類合算:** 「流動資産」「固定資産」「流動負債」など

### 3.5 データテーブル

#### 3.5.1 表示項目
| 列名 | 内容 | 計算方法 |
|------|------|----------|
| 年度 | 年度名（H27, R6など） | - |
| 4月〜3月 | 各月の残高 | データそのまま |
| 年間合計 | 年間の合計値 | 4月〜3月の合計 |
| 前年比 | 前年度との差額比率 | (当年度-前年度)/前年度 × 100% |

#### 3.5.2 月次平均値の表示
**要件:** データテーブルの最終行に「月度平均」行を追加

**計算方法:**
```python
# 選択された全年度の各月の平均値を算出
月度平均の4月 = (R4の4月 + R5の4月 + R6の4月) / 3
月度平均の5月 = (R4の5月 + R5の5月 + R6の5月) / 3
...
月度平均の年間合計 = 各年度の年間合計の平均
```

**表示形式:**
```
年度      4月         5月        ...  年間合計    前年比
R4    12,345,678  13,456,789  ...  150,000,000  +5.2%
R5    13,456,789  14,567,890  ...  157,500,000  +5.0%
R6    14,567,890  15,678,901  ...  165,375,000  +5.0%
月度平均 13,456,786  14,567,860  ...  157,625,000  -
```

**注意:**
- 月度平均の「前年比」は空欄（計算しない）
- 金額は3桁カンマ区切り表示

#### 3.5.3 フォーマット
- 金額: 3桁カンマ区切り（例: 12,345,678）
- 前年比: パーセンテージ表示（例: +5.2%, -3.1%）
- 空欄: ハイフン「-」で表示

### 3.6 エクスポート機能

#### 3.6.1 CSV出力
**既存機能を流用:** `modules/exporter.py`の`export_to_csv()`

**ファイル名形式:**
```
BS_{科目名}_{YYYYMMDD}.csv
例: BS_流動資産_20251209.csv
```

**エンコーディング:** UTF-8 BOM付き（Excel対応）

#### 3.6.2 Excel出力
**既存機能を流用:** `modules/exporter.py`の`export_to_excel()`

**シート名:** 科目名（最大31文字）

**書式設定:**
- 罫線: 全セル
- 数値: 3桁カンマ区切り
- 前年比: パーセンテージ表示（プラスは緑、マイナスは赤）

---

## 4. UI/UX要件

### 4.1 サイドバー構成（BSタブ）

```
⚙️ 設定

1. 科目選択
   [ドロップダウン]
   📊 大分類：流動資産（合算）
   📊 大分類：固定資産（合算）
   📊 大分類：流動負債（合算）
   📊 大分類：固定負債（合算）
   📊 大分類：純資産（合算）
   📈 中分類：現金及び預金（合算）
   📈 中分類：有形固定資産（合算）
   📈 中分類：投資その他資産（合算）
   現金 (111) - 流動資産
   南都普通 (130) - 流動資産
   ...

---

2. 年度選択
   最大5年度まで選択可能
   [マルチセレクト]
   □ H27
   □ H28
   ...
   ☑ R5
   ☑ R6

---

3. データエクスポート
   [📥 CSV ダウンロード]
   [📥 Excel ダウンロード]

---

📁 利用可能年度: 10年度
📊 科目数: 29科目
```

### 4.2 メインエリア構成（BSタブ）

```
💼 貸借対照表 (BS)

📈 現金 (111)
大分類: 流動資産 | 中分類: 現金及び預金

---

📊 月次残高推移グラフ
[Plotlyインタラクティブグラフ]

---

📋 データテーブル
[年度別残高テーブル + 月度平均行]

#### 📊 統計情報
最新年度残高: 81,232円 (R6)
前年度残高: 150,238円 (R5)
前年比: -45.9%

---

林業財務分析システム v1.1.0 | Powered by Streamlit
```

### 4.3 エラーハンドリング

#### 4.3.1 データ不在時
```
⚠️ BSデータディレクトリが見つかりません: data/monthly_bs
📌 data/monthly_bs ディレクトリに月次BSデータ（{年度}_monthly_bs.csv）を配置してください。
```

#### 4.3.2 科目マスタ不在時
```
⚠️ BS科目マスタが見つかりません。データのみで表示します。
```

#### 4.3.3 年度未選択時
```
👈 サイドバーから年度を選択してください
```

---

## 5. 技術仕様

### 5.1 ファイル構成

```
forest_zaim_app/
├── app.py                          # メインアプリ（タブ追加）
├── modules/
│   ├── __init__.py
│   ├── data_loader.py              # BS読み込み関数を追加
│   ├── visualizer.py               # BS用調整（Y軸ラベルなど）
│   └── exporter.py                 # 流用（変更なし）
├── config/
│   ├── account_master.csv          # PL科目マスタ（既存）
│   └── bs_account_master.csv       # BS科目マスタ（新規）
└── data/
    ├── monthly_pl/                 # PL月次データ（既存）
    │   ├── R6_monthly.csv
    │   └── ...
    └── monthly_bs/                 # BS月次データ（新規）
        ├── R6_monthly_bs.csv
        └── ...
```

### 5.2 モジュール拡張

#### 5.2.1 `modules/data_loader.py`
**追加関数:**
- `load_bs_monthly_data()`
- `load_bs_account_master()`
- `get_available_bs_years()`

**既存関数との差異:**
- 列名処理: 「当月残高」を含む列を「4月」〜「3月」に変換
- 年間合計: BSは「参考値」として計算（流動性分析用）

#### 5.2.2 `modules/visualizer.py`
**調整項目:**
- Y軸ラベル: 「金額（円）」→「残高（円）」
- グラフタイトル: 「月次推移」→「月次残高推移」
- ホバーテキスト: 「金額」→「残高」

**関数追加:**
```python
def create_bs_monthly_trend_chart(
    df: pd.DataFrame,
    account_code: int,
    years: List[str],
    account_name: str,
    df_master: pd.DataFrame = None,
    category_filter: str = None,
    subcategory_filter: str = None
) -> go.Figure:
    """BS専用の月次推移グラフ作成"""
```

#### 5.2.3 `modules/exporter.py`
**変更なし（流用）**
- ファイル名生成時に「BS_」プレフィックスを付与

### 5.3 エンコーディング

| ファイル種別 | エンコーディング |
|-------------|-----------------|
| 月次BSデータ (`*_monthly_bs.csv`) | Shift-JIS |
| BS科目マスタ (`bs_account_master.csv`) | UTF-8 (BOM付き推奨) |
| エクスポートCSV | UTF-8 BOM付き |
| エクスポートExcel | UTF-8 |

### 5.4 年度ソート

PLと同じ`sort_years()`関数を使用:
```python
# 平成（H）→令和（R）の順でソート
# ['R6', 'H27', 'R5'] → ['H27', 'R5', 'R6']
```

---

## 6. テスト要件

### 6.1 単体テスト

| テスト項目 | 内容 | 期待結果 |
|-----------|------|----------|
| BSデータ読み込み | `load_bs_monthly_data()`で全年度読み込み | 正常に統合される |
| BS科目マスタ読み込み | `load_bs_account_master()`でマスタ読み込み | 29科目が正しく読み込まれる |
| 列名変換 | 「4月（当月残高）」→「4月」 | 列名が統一される |
| 年度ソート | 平成・令和混在データ | H27→R5→R6の順 |

### 6.2 結合テスト

| テスト項目 | 内容 | 期待結果 |
|-----------|------|----------|
| タブ切り替え | PL⇔BS間の切り替え | 各タブが独立動作 |
| 大分類合算 | 「流動資産」選択 | 該当科目の合計グラフ表示 |
| 5年度比較 | R2〜R6の5年度選択 | 全年度が同一グラフに表示 |
| 月度平均表示 | データテーブル最終行 | 全年度の月次平均値が表示 |
| CSV出力 | UTF-8 BOM付きで出力 | Excelで文字化けなし |
| Excel出力 | 書式設定付き出力 | 罫線・カンマ区切り・色分けあり |

### 6.3 UIテスト

| テスト項目 | 内容 | 期待結果 |
|-----------|------|----------|
| 科目選択 | ドロップダウンで科目切り替え | グラフとテーブルが更新される |
| 年度選択 | マルチセレクトで年度追加/削除 | リアルタイムでグラフ更新 |
| エクスポート | ダウンロードボタンクリック | ファイルがダウンロードされる |

---

## 7. 実装スケジュール

### Phase 1.5 - BS機能実装（2日間）

#### Day 1: データ基盤構築
- [ ] BS科目マスタ作成（`config/bs_account_master.csv`）
- [ ] `data_loader.py`にBS読み込み関数追加
- [ ] `visualizer.py`にBS用グラフ関数追加
- [ ] 単体テスト実施

#### Day 2: UI統合・テスト
- [ ] `app.py`にタブUI追加
- [ ] BSタブの完全実装
- [ ] 月度平均行の追加
- [ ] 結合テスト・UIテスト実施
- [ ] ドキュメント更新（README.md, CLAUDE.md）

---

## 8. 将来拡張（Phase 2）

### 8.1 財務指標計算
- 流動比率 = 流動資産 / 流動負債 × 100%
- 自己資本比率 = 純資産 / 総資産 × 100%
- 固定比率 = 固定資産 / 純資産 × 100%

### 8.2 BS/PL連動分析
- 総資産利益率（ROA）
- 自己資本利益率（ROE）

### 8.3 期末確定値表示
- `R6_fs.csv`の構成比データ活用

---

## 9. 留意事項

### 9.1 データ特性の違い

| 項目 | PL（損益計算書） | BS（貸借対照表） |
|------|----------------|----------------|
| データ性質 | **フロー**（期間累計） | **ストック**（時点残高） |
| 月次値の意味 | 当月までの累計金額 | 当月末時点の残高 |
| 年間合計の意味 | 期間中の総収支 | 参考値（期末残高×12ではない） |
| 前年比の解釈 | 売上・利益の増減 | 資産・負債の増減 |

### 9.2 BS特有の注意点
1. **残高は時点データ** - 各月末時点の残高を表示
2. **年間合計は参考値** - 流動性分析用（12ヶ月の平均ではない）
3. **負債はマイナス表示しない** - 負債も正の値で表示
4. **科目間の相殺なし** - 借方・貸方を分けて表示

### 9.3 月度平均の解釈
- **複数年度の同月平均** - 季節変動パターンの把握に有効
- 例: 4月の月度平均 = 過去5年の4月残高の平均

---

## 10. 承認

| 役割 | 氏名 | 承認日 |
|------|------|--------|
| 要件定義者 | Claude | 2025-12-09 |
| レビュー担当 | User | - |
| 実装担当 | Claude Code | - |

---

**文書管理:**
- **作成日:** 2025-12-09
- **最終更新:** 2025-12-09
- **バージョン:** 1.0.0
- **次回レビュー予定:** Phase 1.5実装完了後
